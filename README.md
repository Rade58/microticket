# TESTING ISOLATED MICROSERVICES

DAKLE SADA CU SE FOKUSIRATI NA TESTING

JA NISAM DO SADA URADIO NIKAKV AUTOMATED TESTING (U TO SE NE RACUNA MOJE SLANJE REQUEST-OVA WITH HTTPIE ILI WITH INSOMNIA, TU NISAM IMAO NIKAV AUTOMATION OF TESTING)

# SCOPE OF TESTING IN CASE OF MICROSERVICES

DAKLE JA CU WRITE OUT-OVATI SOME CODE, KOJIM CE SE TESTIRATI NAS APP IN AUTOMATED FASHION

MORAM DECIDE-OVATI STA CU POKUSATI DA TESTIRAM

**OVO TI JE WIDE SPECTRUM OF DIFFERENT THINGS THAT WE CAN TEST, `INSIDE A ONE SINGLE TEST`**

OVO NIJE KONACNA LISTA

1. TEST A SINGLE PIECE OF CODE IN ISOLATION

NA PRIMER MOZEMO TESTIRATI SINGLE MIDLEWARE

**OVO SE SMATRA UNIT TESTOM** STO JE TRADITIONAL WAY OF TESTING

2. TEST HOW DIFFERENT PIECES OF CODE WORK TOGETHER

NA PRIMER TESTIRAS TO KAKO Request KOJI JE JEDAN PIECE, FLOW-UJE DO REQUEST HANDLER-A, THROUGH MULTIPLE MIDDLEWARES KOJI SU DRUGI PIECE TOG TESTA

3. TESTIRANJE KAKO RAZLICITE KOMPONENTE WORK-UJU TOGETHER

NA PRIMER U OVOM SLUCAJU JEDNA KOMPONENTA JE MONGODB POD A DRUGA TVOJ MICROERVICE POD, I TI TESTIRAS NA PRIMER DA LI JE WRITEUP TO THE DATABASE COMPLETED KAKO TREBA

4. TESTIRANJE KAKO RAZLICITI MICROSERVICE-OVI WORK-UJU TOGETHER

OVO SU INTEGRATION TESTS

NA PRIMER TESTING CREATING PAYMENT-A U payments MICROSERVICE-U, U POGLEDU KAKO TO UTICE NA orders MICROSERVICE 

**OVAJ POSLEDNJI TIP TESTA OUT OF THE SCOPE OF THIS WORKHOP JER JE KOMPLIKOVANO ZA MICROSERVICE ENVIROMENT**


# TEST GOALS

DA KAZEM NESTO O TESTOVIMA KOJE CU PISATI

1. BASIC REQUEST HANDLING

NA PRIMER TESTIRAS DA KADA NAPRAVIS REQUEST /signup DA LI CES DOBITI RESPONSE SA COOKIE-OM, KOJI IMA JSONWEB TOKEN INSIDE OF IT

2. SOME TESTS AROUND MODELS

PA ZA SADA IMAM SAMO `User` MODEL, KOJI NIJE NESTO KOMPLIKOVAN

**ALI DRUGI MODELI KOJE BUDEM KREIRAO BICE KOMPLIKOVANIJI I ZATO CU IH MORATI TESTIRATI, D SE UVERIM DA IMAJU SVE PIECES OF FUNCTIONALITY KOJI MI BUDU BILI POTREBNI**

3. TESTS AROUND EVENT EMMITING AND RECEIVING

MI JOS NISMO NI DISKUTOVALI O EVENT-OVIMA I EVENT HANDLINGU U OVOM PROJEKTU

ZA auth MICROSERVICE NIJE OVO BITNO, LI BICE BITNO ZA OSTALE MICROSERVICE-OVE

A ON OSTA CES TESTIRATI SU Incoming Event TO THE MICROSERVICE I Outgoing Event FROM THE MICROSERVICE

**OVO CE NAVODNO BITI 'INTEGRATION TESTS' MOJIH MICROSERVICE-A, JER ONI NECE KOMUNICIRATI DIREKTNO VEC POSRENO PUTEM EVENT-OVA, TAKO DA CU TESTIRATI KAKO SE TI EVENT-OVI SEND-UJU I RCEIVE-UJEU I OSTALI PROCESSING KOJI ZAVISI OOD TIH EVENT-OVA**

# KAKO CEMO RUNN-OVATI OVE TEST-OVE

RUNN-OVACEMO IH DIREKTNO IZ TERMINALA BEZ KORISCENJA DOCKER-A

TO ZNACI DA OVO IMPLICIRA DA JE NAS LOKALNI ENVIROMENT CAPABLE OF RUNNING OUR MICROSERVICES

ZA SADA JE SIMPLE ENOUGH, ALI MOZE POSTATI COMPLEXNO U VECIM PROJEKTIMA; TAM OZASIGURNO OVO POSTAJE VEOMA TESKO

## SVE ON OSTO NAM TREBA ZA TESTING

TO JE MONGODB INSTANCA

I NODEJS INSTALIRAN NA NASOL LOKALNOJ MACHINE-I

U VVELIKIM PROJEKTIMA JE I OVO KOMPLEKSNO, JER NEKAD POSTOJI OGROMAN BROJ OVAKVIH DEPENDANCIES, A NEKADA TI TREBA I PARTICULAR OPERATING SYSTEM ZA NEKI, HARD TO SET, DATBASE

# TESTING ARCHITECTURE

KORISTICU `Jest` KAO TESTING FRAMEWORK

DODACEMO NOVI SCRIPT U `package.json` FILE MICROSERVICE-A, A TO JE `npm run test`

ZA SADA IMAM SAMO JEDAN MICROSERVICE, TAKO DA CU TO URADITI, SAMO ZA `auth` MICROSERVICE

## POMENUTI `npm run test` CE POKRENUTI TEST RUNNER, KOJI SE ZOVE `Jest`

ONO STO CEMO MI RECI Jest-U DA URADI KADA SE POKRENE JESTE DA

- STARTUJE IN MEMORY COPIJU MongoDB-JA

OVO ZNACI DA NECU MORATI DA INSTALIRAM MONGO NA MOJOJ MACHINE-I, JER CU KORISTITI IN MEMORY COPY OF MONGODB

- STARTUP-UJE NAS EXPRESS APP (NAS MICROSERVICE)

- DA UZME `supertest` LIBRARY KAKO BI PRAVIO FAKE REQUEST-OVE AGAINST OUR EXPRESS APP

DA BI OVAJ supertest LIBRARY RADDIO KAKO TREBA MORACEMO DA REFAKTORISEMO NAS MICROERVICE

- DA RUNN-UJE ASSERTIONS KAKO BI SE UVERIO DA REQUEST-OVI RADE POTREBNU STVAR (OVO ZNACI DA CEMO ESPOND-OVATI WITH SOME PARTICULAR DATA, ILI CEMO WROTE-OVATI PARTICULAR DATA U ONAJ IN MEMORY COPY OD MONGODB)

## `supertest` LIBRARY

SADA CES VIDETI ZASTO MORAMO REFAKTORISATI NAS APP ZBOG OVOG LIBRARY-JA

POGLEDAJ EXAMPLE IZ [DOKUMENTACIJE](https://github.com/visionmedia/supertest#example)

```ts
const request = require('supertest');
const express = require('express');

// IMAS OVDE CODE ZA KREIRANJE EXPRESS SERVER-A ---------
// OVO JE VAZNO DA SE NALAZI U index.js FAJLU TVOG MICROSERVICE-A
// DAKLE MORAS IMATI DEKLARISANU VARIJABLU ZA SERVER, JER
const app = express();

app.get('/user', function(req, res) {
  res.status(200).json({ name: 'john' });
});

// ------------------------------------------------------
// JER KAO STO VIDIS DOLE U TESTU
// TI KORISTIS TU VARIJABLU
// request DOLAZI IZ SUPERTEST LIBRARY-JA
// ONDA SE PISE REQUEST, I PISU SE SOME EXPECTATIONS AROUND IT
request(app)
  .get('/user')
  .expect('Content-Type', /json/)
  .expect('Content-Length', '15')
  .expect(200)
  .end(function(err, res) {
    if (err) throw err;
  });
```

**DAKLE MORAS IMATI EXPRESS APP U index.js FILE-U, JER TI U TEST FILE-U POKUSATI DA REQUIRE-UJES EXPRESS APPLICATION, IZ POMENUTOG index.js FILE-A**

DAKLE NA TAJ NACIN TEST FILE IMA ACCESS DO NASE app VARIJABLE

MI U /auth/index.ts IMAMO DOSTA STARTUP CODE, OD TOGA DA GOVORIMO APP DA POCNE DA LISTEN-UE ON SOME GIVEN PORT, A PRE TOGA SMO HARDCODE-OVALI MONGOOSE CONNECTION DO MONGODB DATBASE-A NA PARTICULAR URL-U 

MENI JE TAMO HARDOCED PORT NA KOJEM TREBA DA LISTEN-UJE EXPRSS SERVER 

**PROBLEM OVDE MOZE NASTATI AKO IMAS MULTIPLE MICROSERVICES, SA EXPRESS SERVERIMA, KOJI LISTEN-UJU NA ISTOM PORTU; I TO NIJE PROBLEM JER SVAKI OD TIH MICROSERVICE-OVA RUNN-UJE U THER OWN VIRTUAL MACHINE-U (U ODVOJENIM POD-OVIMA), `ALI JE NAARAVNO PROBLEM PRI TESTIRANJU MUTLIPLE MICROSERVICE-OVA, JER JA KAO STO SAM REKAO TESTIRAM NA MOJOJ LOKALNOJ MACHINE-I`**

**MEDJUTIMM IKO IMAS MULTIPLE MICROSERVICES CIJI SERVERI LISTEN-UJU NA ISTOM PORT-U, `supertest` LIBRARY IMA RESENJE ZA TO, TAKO DA NE MORAS MENJATI PORT-OVE U TVOM CODEBASE-U; ALI IPAK MORAS NESTO DODATNO ODRADITI**

SUPERTEST CE USTVTI PICK-OVATI RANDOM AVAILABLE PORT (KOJI SE JOS NAZIVA I EPHEMERAL PORTOM) ON YOUR COMPUTER, AKO JE PORT SPECIFIED U CODEBASE, USTVARI BUSY

**MEDJUTIM OVA OPCIJA JEDINO RADI AKO NISI SPECIFICIRAO NIKAKAV LISTENING PORTA ZA TVOJ SERVER**

**REFACTORING, KOJI PRAVIS U index.js FILE-U JESTE DA TI U TJ FILE UVOZIS TVOJ EXPRESS APP**

STO ZNACI DA CU MORATI KREIRATI NOVI FILE, KOJ ICE SAMO HOLD-OVATI TAJ APP

KREIRACU FILE app.js U KOJEM CE SE NALAZITI SERVER MOG MICROSERVICE,A ALI BEZ ONE LISTENING LOGIKE

DAKLE IMACES `index.ts` KOJI EXECUTE-UJES U PROD/DEV ENVIROMENTU; STO NIJE SPORNO

ALI DEFINISACES app.ts FILE I NECE IMATI NIAKVU PORT, ODNOOSNO LISTENING LOGIKU, A IZ NJEGA CU IZVESTI EXPRESS APP

MEDJUTIM BOLJE JE DA OVO SVE IMPLEMENTIRAM NEGO DA OBJASNJAVAM

TO CU U SLEDECEM BRANCH-U

