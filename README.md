# NATS CLIENT ID GENERATION

***
***
***
***

DA MALO REKAPITULIRAM

USPESNO SAM POSTAVIO PUBLISHERA CIJA JE ULOGA DA PUBLISH-UJE EVENTS DO NATS STREAMING SERVERA

POSTO PRAVI MSAMI SIMPLE PROJECT, JEDIN INACIN KOJI SAMO STAVIO PUBLISHE-RU JE DA SE RESTARTINGOM PROSTO SCRIPTA (ILI PROMENOM FILE-A I SAVINGOM), RE RUN-UJE TAJ ts-node-dev KOJI PORED STO TRANSPILE-UJE TYPESCRIPT, TAKODJE RUN-UJE TRANSPILED JAVASCRIPT KAO EXECUTABLE, **CIME JA USTVARI RERUN-UJEM ONAJ CODE KOJI PUBLISH-UJE EVENT, ODNOSNO PUBLISHUJE ODREDJENI DATA, U ODREDJENI CHANNEL (DAO SAM MU IME `"tickets:created"`) U STREMAING SERVERU**

**SA DRUGE STRANE IMAM LISTENERA KOJEG  SAM PODESIO, I KOJI TKAV DOBIJA, EVENT-OVE, ODNOSNO Message U KOJEM JE EMBEDED DATA, IZMEDJU OSTALOG**

**A SVE ZATO JER SAM LISTENERA SUBSCRIBE-OVAO NA CHNNEL `"tickets:created"`**

DAKLE NATS STREAMING SERVER RADI STALNO I KADA SE GOD POSALJE EVENT TO JE ZABELEZENO (TAKORECI CUVA SE IN MEMORY PO DEFULTU A MOZE DA SE PODESI I DATABASE, POSEBNOM OPCIJOM, STO JOS NISAM RADIO)

***
***

DA TI REKAPITULIRAM POKRETNAJE I FLOW

JEDAN TERMIANL TI JE EXPOSE-OVO PORT NATS TREAMING SERVERA KOJI RUN-UJE U PODU NA TVOM CLUSTERU JER SI POKRENUO SLDECE:

- `k get pods`

- `kubectl port-forward <ime pod-a> <port nats streaming ser>:<port na kojem ti zelis d slisas na locl machine-u>` (PORTOVI SU 4222:4222 (TO STAVLJAS))

**LISTENER TERMINAL:**

- `cd nats_test_project`

- `yarn listen`

**PUBLISHER TERMINAL:**

- `cd nats_test_project`

- `yarn run publish`

ZA REPUBLISHING EVENTS MORAS RETARTOVATI OVAJ POSLEDNJI SCRIPT ILI MODIFIKOVATI `nats_test_project/src/publisher.ts`, UBACIVANJE I IZBACIVANJE RANDOM COMMENT-A I SAVE-OVATI

***
***
***
***

DA SE SADA VRATIM NA TEMU

DA KRENEM OD PROBLEMA

STA DA NA PRIMER JA IMAM JOS JEDAN MICROSERVICE

ILI JOS BOLJE, MOGU RECI DA NEKI MOJ POSTOJECI SERVICE IS GETTING A LOT OF TRFFIC

**MOGU ODLUCITI DA SCALE-UJEM MICROSERVICE IN SOME WAY**

**MOGU GA SCALE-OVATI VERTIKALNO DAJUCI MIU MORE POWERFUL CPU, MORE RAM I TAKO DALJE**

**ILI MOGU DA IZABEREM DA GA SCALE-UJEM HORIZONTALY, TAKO STO CU KREIRATI SECOND INSTANCE TOG SERVICE-A**

**TKO DA MOES IMATI DVE KOPIJE, EXACT SAME MICROSERVICE-A, ND IN ALL REGARDS THEIR ARE IDENTICAL IN NATURE**

NARAVNO MORAO BI SE POSTARATI DA OBA MICROSERVICE-A BUDU CONNECTED DO NATS STREAMING SERVER

## JA CU POKUSATI DA TAJ HORIZONTALNI SCALING, SIMULIRATI  POKRETANJEM, JOS JEDNOG LISTENER SCRIPT-A

DAKLE IDEJA JE DA OTVARIM NOVI TERMINAL I U NJEMU POKRENEM OPET LISTENER SCRIPT

STO SE NADAM DA CE POKRENUTI LISTNERA, I STO SE NADAM DA CE ISTO OBAVITI SUBSCRIPTION, ZA `"tickets:created"` EVENT

IDEJJA JE DA IMAM I DALJE JEDNOG PUBLISHER-A I IMAS JEDAN NATS STREAMING SERVER

ALI ZELIM DA IMAM DVA RUNNING LISTENER-A

- `cd nats_test_project/package.json`

- `yarn listen`

**MEDJUTIM OVO NECE PROCI JER CES DOBITI ERROR**

```zsh
Error [ERR_UNHANDLED_ERROR]: Unhandled error. ('stan: clientID already registered')

```

DAKLE GOVORI TI DA TI JE CLIENT ID ALREADY REGISTERED

**AKO SE SECAS, KADA SI KONEKTOVAO LISTENERA, TI SI PORED URL-A I OSTALOGA, OBEZBEDIO I DODATNE ARGUMENTE, E PA JEDAN OD NJIH JE ID CLIENT-A, ODNOSNO TO JE ID LISTENERA** (TAKODJE SI TO RADIO I ZA PUBLISHERA)

NE MORAS DA ZATVARS I TAJ ERORREUS HANGING TERMINAL

EVO, MOZES VIDETI KOJI SI CLIENT ID PODESIO ZA LISTENER-A

- `cat nats_test_project/src/listener.ts`

```ts
import nats, { Message } from "node-nats-streaming";

console.clear();

// EVO VIDIS "123" KOJI SAM DODAO
// TO JE ID stan CLIENT-A
const stan = nats.connect("microticket", "123", {
  url: "http://localhost:4222",
});

stan.on("connect", () => {
  console.log("Listener connected to nats");

  const subscription = stan.subscribe("ticket:created");

  subscription.on("message", (msg: Message) => {
    const eventNumber = msg.getSequence();
    const topic = msg.getSubject();
    console.log({ topic, eventNumber });
    const data = msg.getData();

    if (typeof data === "string") {
      const dataObject = JSON.parse(data);

      console.log(dataObject.title);
      console.log(dataObject.id);
      console.log(dataObject.price);
    }
  });
});

```

**NATS STREAMING SERVER KEEP-UJE RECORD O CLIENTIMA KOJI SU CONNECTED**

A ONO STA SI TI POKUSAO JESTE DA KONEKTUJE DODATNOG LISTENER CLIENTA, ALI SA ISTIM ID-JEM KOJI VEC IMA JEDAN CLIENT, KOJI JE ALREADY CONNECTED

## NATS STREAMING SERVER NE DOZVOLJVA DUPLIKATE stan CLIENT ID-JA

ZATO SI I VIDEO, POMENUTI ERROR MESSAGE

DAKLE SVAKI PUT KADA ZELIS DA RUNN-UJES MULTIPLE CLIENTS, BIL ODA SU TO PUBLISHERS OR LISTENERS, SVAKI OD NJIH MORA BITI CONNECTED SA RAZLICITIM ID-JEM

**KUBERNETES TI PRUZA EASY WAY TO DEAL WITH THAT (MI CEMO TO KASNIJE OTKRITI), ALI MI SADA RUNN-UJEMO PUBLISHER-A I LISTENERE NA LOKALNOM MACHINE-U**

ALI ZA SADA U OVOM "TEST ENVIROMENTU" (U SUBPROJECTU) U KOJEM SAM, JA CU NAPRAVITI WORKAROUND

## POKUSACU DA DEFINISEM RANDOMIZATION PRI KREIRANJU TOG CLIENT ID-JA, KAKO BI MOGAO DA RUNN-UJEM ISTI SCRIPT DVA PUTA, CIME BI MI SE NA TAJ NACIN KONEKTOVALA DVA RAZLICITA LISTENER-A

- `code nats_test_project/src/listener.ts`

```ts
import nats, { Message } from "node-nats-streaming";

// EVO SA OVIM CU DA GENERISEM RANDOM STRING
import { randomBytes } from "crypto";

console.clear();

// EVO VIDIS, GENERISEM ID
const stan = nats.connect("microticket", randomBytes(4).toString("hex"), {
  url: "http://localhost:4222",
});

stan.on("connect", () => {
  console.log("Listener connected to nats");

  const subscription = stan.subscribe("ticket:created");

  subscription.on("message", (msg: Message) => {
    const eventNumber = msg.getSequence();
    const topic = msg.getSubject();
    console.log({ topic, eventNumber });
    const data = msg.getData();

    if (typeof data === "string") {
      const dataObject = JSON.parse(data);

      console.log(dataObject.title);
      console.log(dataObject.id);
      console.log(dataObject.price);
    }
  });
});

```

MOZES SADA SAM O DA SAVE-UJES

NE TREBA NISTA DA POKRECES JER TI SVI TERMINALI HANG-UJU, A ONAJ ts-node-dev SE STARA O RESTARTU

SADA MOZES DA RESTARTUJES PUBLISHER, NA NACIN KAKO SAM TI OBJASNIO, VEC MNOGO PUTA RANIJE

I ZNAS DA BI TIME TREBALO DA SE PUBLISH-UJE EVENT, JER SI TAKO PODESIO

I STVARNO SAM U TERMINALIMA OBA LISTENERA VIDEO DA SE STMAPA, ONO STO SMA ZADA ODA SE STAMPA, NAKON STO LISTENER, DOBIJE EVENT
