# BUILDING AN IMAGE IN A GITHUB ACTION

SADA CEMO SAGRADITI NAS PRVI WORKFLOW, KOJIM CEMO SE POSTARATI DA SE BUILD-UJE IMAGE FOR THE `auth` MICROSERVICE; DA SE ON ONDA PUSH-UJE TO DOCKER HUB; I OSTALO

DAKLE OPET IDEMO NA NAS REPO NA GITUB-U I BIRAMO `Actions` TAB; I KLIKCEMO NA `New Workflow` PA KLIKNI DA `set up a workflow yourself`

IZBRISI SAV CODE KOJI JE VEC TAMO BIO DEFINISAN I ZADAJ IME ZA WORKFLOW DA BUDE `deploy-auth.yml`

SADA CEMO PISATI CONFIIG KOJI CE DICTATE-OVATI KADA CE SE RUNN-OVATI, I STA CE EXACTLY RADITI

EVO TI ZA POCETAK DEFINISEMO DA SE ACTION RUNN-UJE SAMO AAKO SE DESILA PROMENA U `auth` FOLDERU

**ALI VIDECES DA SAM DEFINISAO DA SE ACTION OBVLJA ZA `push` RELATED TO `main` BRANCH**

`deploy-auth.yml`:

```yml
name: deploy-auth

on:
  push:
    branches:
      - main
    paths:
      - 'auth/**'
```

**ZASTO `push`?**

**PA KADA GOD MI CLOSE-UJEMO ILI MERGE-UJMO PULL REQUEST; THAT COUNTS AS A `push` DIRECTLY TO THE `main` BRANCH** (**`D TO POTPUNO IMA SMISLA`**)

DAKLE CHECK KOJ ISAM PODESIO RUNN-OVCE POMENUTI WORKFLOW ,SVAKI PUT KADA MERGE-UJEMO PULL REQUEST INTO THE MASTER BRANCH

A RUNN-OVACE SE SAMO AKO POSTOJI CHANE U `auth` FOLDERU

SADA CEMO DA DODAMO JOBS

`deploy-auth.yml`:

```yml
name: deploy-auth

on:
  push:
    branches:
      - main
    paths:
      - 'auth/**'
# EVO, OVO DODAJEM
# ZADAJEM MU IME build
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
# OVO ZNACI CHECKOUT ALL OF OUR CODE INSIDE OF OUR REPO
      - uses: actions/checkout@v2
# SADA DEFINISEMO KOMANDE KOJE CE SE RUNN-OVATI
# SAMO DA TI KAZEM DA ubuntu-latest DOLAZI SA PREINSTALLED 
# DOCKEROM, TAKO DA TU INSTALACIJU INSIDE COMMAND, NE MORAS
# DEFINISATI 
      # mt MI JE SKARACENO ZA microticket (TO MI JE NAJLOGICNIJE DA SMISLIM)      
      - run: cd auth && docker build -t radebajic/mt-auth 

# NAKON STO SE BUILD-UJE IMAGE, TREBA DA SE PUSH-UJE TO DOCKER 
# HUB
# ALI MORAS BITI LOGGED IN INTO DOCKER CLI; DAKLE DOCKER CLI MORA ZNATI
# KO SI TI ZAPRAVO, DA BI SME DA PUSH-UJES TO DOCKER HUB
# ALI PROBLEM JE ST OSE SCRIPT NECE EXECUTE-OVATI NA MOJOJ LIKALNOJ
# MACHINE, VEC U CONTAINERU KOJI MANGE-UJE GITHUB GITHUB-A
# MORAMO NEKAKO RECI DOCKERU DA ME LOGG-UJE KORISTECI
# MOJE IME I PASSWORD
# NECEMO IME I SIFRU UNOSITI DIREKTNO U SCRIPT OVDE
# VEC CEMO DODATI USER NAME I PASSWORD, KO SECRET
```

# DAKLE MOJE DOCKER CREDENTIALS DODAJEM INTO REPOSITORY KAO SECRET

COMMIT-UJ GORNJI FILE ZA SADA (PRITISNI `Start Commit` DUGME I OSTALO), KAKO BI MOGLI DA SE NAVIGTE-UJEMO AWAY, JER CEMO MORATI DA PRITISNEMO NA `Settings` TAB NASEG REPO-A (MADA SMO MOGLI DA `Settings` OTVORIMO U NOVOM BROWSER-OVOM TABU)

UGLAVNOM OTVORILI SMO `Settings` --> `Secrets` --> `New repository secret`

DODAO SAM `DOCKER_USERNAME` SECRET

PA SAM DODAO JOS JEDAN SECRET, A TO JE `DOCKER_PASSWORD`

SADA IMAMO DOSTUPNIM POMENUTE SECRET-OVE U NASIM GITHUB ACTIONIMA, KAO ENV VARIABLES

# VRACAMO SE DA EDIT-UJEMO NAS WORKFLOW FILE, KAKO BI SMO REFERENCIRALI SECRETS, KOJE SAM PODESIO ;A TO SE RADI UZ DODAVANJE $ SIGN-A ISPRED ENV VARIABLE-A; ALI MORACES DA PODESIS ENV VARIABLES

I PAZI DA NE NAPRAVIS NEKI TYPO

```yml
name: deploy-auth

on:
  push:
    branches:
      - main
    paths:
      - 'auth/**'
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2   
      - run: cd auth && docker build -t radebajic/mt-auth .
      # UNOSIM NOVI run
      # KAO STO VIDIS REFERENCIRAM SECRETS KAO ENV VARIABLES
      - run: docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
        env:
          # A OVDE USTVARI PODESAVAMKOJE DA SE SE SECRETS UZMU I PODESE
          # KAO ENV VARIABLES
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
      # SADA MOZEMO DEFINISATI PUSHING IMAGE-A TO DOCKER HUB
      - run: docker push radebajic/mt-auth
```

MOZEMO DA COMMIT-IJEMO OVAJ FILE (`Start commit` DUGME)

# MOZEMO SADA DA POKUSAMO OVO DA TESTIRAMO, TAKO STO CEMO PRECI U NAS `dev` BRANCH, PA CEMO NAPRAVITI NEKE IZMENE U `auth` MICROSERVICE-U, PA CEMO TO COMMIT-OVATI I PUSH-OVACEMO TO REMOTE `dev` BRANCH; A ONDA CEMO NA GITHUB-U NAPRAVITI PULL REQUEST TO MERGE `dev` INTO `main`

A U BUDUCNOSTI KADA BUDES PRAVIO PULL REQUEST NEMOJ DA GA MEGE-UJES ALL THE WAY, JER NE ZELIM DA TOKOM OVOG RADA STALNO MORAM DA PRAVIM PULL REQUESTS, JER I UPDATE TO ALLREADY OPENED PULL REQUEST, CE TAKODJE TRIGGER-OVATI EVENTS

- `git checkout dev`

EVO SADA PRAVIM PROMENU U `auth` MICROSERVICE CODEBASE-U

PA 
