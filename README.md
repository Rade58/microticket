# RUNNING TESTS IN PARALLEL

DO SADA NAM GITHUB WORKFLLOW IZGLEDA PRETTY GOOD; ALI SAMO RUNN-UJE TESTS ZA NAS auth MICROSERVICE

MORAMO SE POSTARATI DA SE TESTOVI RUNN-UJU I ZA NASE DRUGE MICROSERVICE-OVE, KADA SE DESI EVENT-OVI. VEZANI ZA PULL REQUEST, O KOJIMA SAM GOVORIO

## DAKLE, KONFIGURACIJE ZA GITHUB ACTION, MOGU ODEFINISATI DIREKTNO NA GITHUB-U, DEFINISANJEM INSIDE `.github/workflows` FOLDER-A, KOJEG SADA IMAMO U NASEM PROJECT-U

AUTOR WORKSHOPA TO RADI DIREKTNO NA GITHUB-U, IAKO TI I LOKALNO IMAS TAJ FOLDER, JER M ISAD IMAO `.github/workflows/tests.yml`,  UNASEM PROJECT-U

# MI MOZEMO SVE DEFINISATI IN ONE FILE, I MOGLI SMO DEFINISATI STRATING TEST KOMANDI IN SEQUENCE (SAMO BI STAVLJAO && ILI NOVE `- run` STEPOVE) ,ALI MI TO NECEMO URADITI

MI NE ZELIMO ZA SVE NASE TESTOVE DA IH RUNN-UJEMO IN SERIES, ODNOSNO KADA ZAVRSI JEDAN POCEO BI DRUGI, **TO BI POTRAJALO PA I NEKOLIKO MINUTA**

TEHNICKI POSTOJI DRUGI NACIN SA KOJIM MOZEMO WIRE-OVATI, SVE TESTING WOKFLOWS, KAKO BISMO OMOGUCILI DA SVI RUNN-UJU IN PARALELL

**MOZEMO DEFINISATI ADDITIONAL WORKFLOWS, KOJI CE SE EXECUTE-OVATI, ON `pull_request`**

## ZA POCETAK CEMO ON GITHUB EDIT-OVATI, VEC POSTOJECI yml FILE (`.github/workflows/tests.yml`), KOJI IMAMO, KAKO BISMO NAZNACILI DA JE REC O WORKFLOW-U NAMENJENOM ZA `auth` MICROSERVICE

PROMENICMEMO MU IME U `test-auth.yml`

I PROMENICEMO `name` NA `test-auth`

DAKLE OVO SAM ODRADIO DIEKTNO U REPO-U NA GITHUB, I PRITISNUO SAM NA COMMIT DUGME UPRAV TU U DASBOARD-U

JA SADA MOGU KOPIRATI SADRZAJ POMENUTOG FILE-A, I ISKORISTITI TO KAO NEK UPOLAZNU TACKU PRI PRAVLJANJU WORKFLOW FILE-OVA ZA DRUGE MICROSERVICE-OVE

EVO NAPRAVICU JOS JEDAN WORKFLOW FILE (RADIM TO DAKLE DIREKTNO NA GITHUB-U)

`.github/workflows/tests-tickets.yml`

I UKUPNO MENJAM DVE STVARI U SADRZINI, KOJU SAM PREKOPIRAO, IZ ONOG PRVOG FILE, KOJEG SAM NAPRAVIO

```yml
# EVO SAMO DEFINISEM OVO IME U tests-tickets
name: tests-tickets

on:
  pull_request

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      # I OVDE DEFINSEM `cd tickets`
      - run: cd cd tickets && npm install && npm run test:ci

```

KREIRACU I OSTALE 

I SADA ZNAS STA TREBAS DEFINISATI

ISTO RADIS ZA SVE OSTALE MICROSERVICES, OSIM ZA `expiration` I ZA `client` JER TAMO NISMO DEFINISALI NIKAKVE TESTOVE

DAKLE DEFINISEMO JOS `tests-orders.yml`, `tests-payments.yml` 

**DAKLE ,SVE POMENUTO SMO URADILI, U CILJU DA NAM TESTS RUNN-UJU IN PARALLEL SVAKUI PUT KADA NAPRAVIMP PULL REQUEST, ILI UPDATE-UJEMO TAJ PULL**

## UMALO DA ZABORAVIMO DA DODAMO USTVARI `test:ci` SCRIPT U NASIM MICROSERVICE-OVIMA

DAKLE `package.json` U MICROSERVICE-OVIMA, U KOJIMA IMAMO DEFINISANE TESTOVE, MORMO DODATI OVAKAV SCRIPT

- `code payments/package.json`

- `code orders/package.json`

- `code tickets/package.json`

```json
// DODAJEM OVAJ SCRIPT ZA SVAKI OD POMENUTIH FAJLOVA
"test:ci": "jest"
```

ZA `auth` MICROSERVICE, TO SMO VEC RANIJE URADILI

## UKLONI ONAJ `.github/workflows/tests.yml` IZ SVOG PROJECT-A

- `rm .github/workflows/tests.yml `

## PRVO CEMO DA COMMIT-UJEMO NASE PROMENE

**MI SE DAKLE NALAZIMO U `dev` BRANCH-U**

- `git add -A`

- `git commit -a "added test scripts"`

## PA MOZEMO A PULL-UJEMO DOWN PROMENE KOJE SAM DEFINISAO DIREKTNO EDITINGOM NA GITHUBU; GOVORIM O SVIM TIM `yml` FILE-OVIMA KOJE SAM KREIRAO INSIDE `.github/workflows`

- `git pull origin main`

## SADA CEMO DA PUSH-UJEMO CHANGES TO REMOTE `dev` BRANCH

CISTO DA SIMULIRAS NEKI REAL SCENARIO, MOZES PROMENITI MALO CODEBASE (PONOVO COMMIT-OVATI CHANGES)

I PUSH0-UJ SADA TO REMOTE dev BRANCH

- `git push origin dev` (ILI `git push`, AKO JE RANIJE PODESEN `git push -u origin dev`)

# SADA MOZEMO DA ODEMO NA GITHUB I CREATE-UJEMO PULL REQUEST, U KRAJNJEM NAUMU DA MERGE-UJEMO `dev` BRANCH INTO `main` BRANCH 

DAKLE OTVARAMO `Pull requests` TAB I PRAVIMO `New pull request`

PISEMO MESSAGE I NASLOV ZA PULL REQUEST, I KLIKNEMO DA BI SMO KREIRALI PULL REQUEST

**VIDECEMO DA JE BOX POSATAO ZUT, I VIDI SE DA SVI WORKFLOWS RUNN-UJU IN PARALLEL**

SVI TESTOVI SU PROSLI OSIM payments-A

IZ `Details` ZA `tests-payments` VIDIM DA JE FAIL-OVALA STRIPE AUTHORIZATION

STO ZNACI DA NE BI BILO DOBRO DA MERGE-UJEMO JER NESTO NIJE U REDU

***
***

POPRAVKA:

TEST A payments MI PROLAZI LOKALNO NA MACHINE-U

ALI NE PROLAZI NA GITHUB-U IZ JEDNOG RAZLOGA

**ZATO STO JA USCITAVAM STRIPE API SECRET KEY FROM THE `.env` FILE, KOJI `NE COMMIT-UJEM TO GITHUB`**

NEMAM DRUGOG RALOGA NEGO DA OPET VRATIM DA SE `stripe.check.create`, MOCK-UJE

OPET SAM VRATIO DA IMAM OVAJ FILE: `payments/src/__mocks__/stripe.ts` (**VIDI STA SVE IMAM TAMO**)

DODACES I `jest.mock("../stripe.ts");` U FILE `payments/src/test/setup.ts`

POSTO SADA MOCK-UJEMO, MISLIM DA CES MORATI DA UKLONIS IZ TESTA ONE PROVERE GDE MI SALJEMO REQUETS PREMA STRIPE API-JU DA VIDIMO DA LI JE CHARGE KREIRAN (CHARGES SADA NECE KROZ RUNNING TESTOVA BITI KREIRAN JER SMO MOCK-OVALI, I ZATO CES DA UKLONIS, TE EXPECTATIONS)

RUNN-UJ TEST LOKALNO DA VIDIMO DA LI CE PROCI

- `cd payments`

- `yarn test:ci`

**TESTOVI SU PROSLI**

***
***

SADA COMMIT-UJ

- `git add -A`

- `git commit -am "mocking stripe"`

**I PUSH-UJEMO**

- `git push origin dev` (ILI `git push`, AKO JE RANIJE PODESEN `git push -u origin dev`)

A POSTO NISMO CLOSE-OVALI PULL REQUEST, TO ZNACI DA CE SE TRIGER-OVATI UPDATE EVENT ZA PULL REQUEST, I OPET CE SE POKRENUTI NASI ACTIONI, ODNOSNO NASI WORKFLOWS. I OPET CE RUNN-OVATI IN PARALELL

I OPET MOZES DA OTVORIS `Details` ZA SVAKI OD CHECK-OVA

UGLAVNOM SVAKI OD TIH WORKFLOW-OVA JE RUNN-OVAO BRZO, JER SU RUNN-OVALI PARLALNO

DAKLE MOGAO SAM VIDETI ZELENI CHECKMARK I PISACE `All checks have passed`

**SADA KONACNO MOZEMO DA MERGE-UJEMO PULL REQUEST INTO `main` BRNCH**

CONFIRM-OVALI SMO MERGE I PULL REQUEST JE SUCCESSFULLY MERGED AND CLOSED
