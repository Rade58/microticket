# COOKIES AND ENCRYPTION

DAKLE U PROSLOM BRANCH-U SAM REKAO KAKO CE TECI AUTHENTICATION U SLUCAJU SIGNUP-A, ODNOSNO ONDA KADA KORISNIK NAPRAVI ACCOUNT, ODNOSNO KADA PRVI PUT, REQUESTOM HITT-UJE `/api/users/signup` ROUTE

1. KORISNIK SALJE POMENUTI REQUEST, KOJI NA SEBI IMA `{email, password}`

- PROVERAVA SE DA LI EMAIL VEC POSTOJI, AKO POSTOJI RESPOND-OVACE SE SA ERROR MESSAGE-OM (NARAVNO ERROR MIDDLEWARE JE ODGOVORAN ZA SLANJE REQUEST-A (SAMO TI NAPOMINJEM AKO SI ZABORAVIO))

- AKO NIJE POSTOJAO TAKAV USER USER, STORE-UJEMO GA, ALI HASH-UJEMO PASSWORD PRILIKOM STORINGA U DATABASE-U I Users KOLEKCIJI 

- USER JE SADA CONSIDERED TO BE LOGGED IN

2. **I MI MU SALJEMO JWT, DO CLIENT-A INSIDE A COOKIE; ODNOSNO SALJEMO JWT AS A `Set-Cookie` HEADER**

# SADA CU TI POKAZATI STA CEMO KORISTITI ZA MANAGING COOKIE-A, I TAJ LIBRARY CU KORISTITI ACROSS ALL DIFFERENT SERVICES, KAKO BI SMO MOGLI DA READ-UJEMO DATA IZ COOKIE-A

LIBRARY SE ZOVE ['cookie-session'](https://www.npmjs.com/package/cookie-session)

PAKET KO PAKET OMOGUCAVA STORING A LOT OF INFORMATIONS INSIDE A COOKIE ITSELF; TI PROCITAJ [DOCSE](https://github.com/expressjs/cookie-session#readme) ZA OSTALI INFO 

OVO JE DOBRO RESENJE JER SE NE RELY-UJE ON BACKING DATA STORE, STO JE U MOM SLUCAJU REQUIREMENT MOJE ARHITEKTURE DA MI SE AUTH MECHANISM NE RELY-UJE ON BACKING DATA STORE

# REKAO SAM DA JE REQUIREMENT ZA MOJ AUTH MECHANISM DA ON BUDE LAKO RAZUMLJIV IZMEDJU RAZLICITIH LANGUAGE-OVA; E PA TO MOZE BITI CHALLENGING IU SLUCAJU COOKIE-A

OVO JE ZATO STO JE OFTEN TIME, CONTENT OF THE COOKIE USTVARI ENCRYPTED

`cookie-session` SUPPORT-UJE ENCRYPTION, I JA MOGU KORISTITI OVJ PAKET DA ENCRYPT-UJEM CONTENT OF THE COOKIE

TO NAS MOZE UVUCI U PROBLEME JER OVAJ PAKET SIGURNO SUPPORT-UJE NEKI ENCRYPTION ALGORITHM, KOJI MOZDA NE POSTOJU U RUBY-JU ILI U PYTHON-U, I JA BIH GA MORAO PRONACI I INSTALIRATI

# DAKLE MI SE MORAMO UVERITI DA JE CONTENT OF THE COOKIE EASYLY UNDERSTOOD BY DIFFERENT LANGUAGES

JA ZATO NECU ENCYPTOVATI DATA OF THE COOKIE, JER JE NJEGOV CONTENT, A TO CE BITI JSON WEB TOKEN, USTVARI TAMPER RESISTANT

**U TEORIJI JE NE ENCRYPTYING COOKIE-A SECURITY ISSUE, JER MALICIOUS KORISNIK ONDA MOZE CITATI CONTENT COOKIE-A**

**ALI KAO STO REKOH TO NIJE A BIG DEAL FOR US, JER KORISTIMO JWT KOJI VEC IMA SVOJU ENKRIPCIJU**

ODNOSNO AKO MALICIOUS KORISNIK POKUSA DA MODIFICIRA JWT, ON CE BITI INVALID KADA SE PARSE-UJE

DAKLE INFORMACIJA STORED U JWT SE NE MOZE MODIFIKOVATI I MENJATI I TO JE NAJBITNIJE

**OVO TI MOZE IZGLEDATI KAO BIG DEAL**

ALI TI IONAKO NECES STORE-OVATI PROTECTED INFO U JSON WEB TOKENU, NECES NA PRIMETR KORISTITI PASSWOD KORISNIKA, INSIDE PAYLOAD, KADA BUDS BUILD-OVAO JWT

**ALI AKO TI JE VAZNO TI GA MOZES ENCRYPT-OVATI, ALI SI ONDA U RIZIKU, KADA PRAVIS MICROSERVICE, KOJI KORISTI DIFFERENT LANGUAGE, JER CES TADA IMATI PROBLEM DA DECRYPT-UJES COOKIE**

JA GA NECU ENCRYPTOVATI, SAMO DA ZNAS

# ADDING A SESSION SUPPORT

SADA CU DAKLE INSTALIRATI POMENUTI `cookie-session` PAKET

>> Simple cookie-based session middleware.

>> A user session can be stored in two main ways with cookies: on the server or on the client. This module stores the session data on the client within a cookie, while a module like express-session stores only a session identifier on the client within a cookie and stores the session data on the server, typically in a database.

**KAO STO VIDIS OVAJ PAKET TE DAKLE OSLOBDJA TOGA DA MORAS IMATI BACKING DATBASE**

- `cd auth`

- `yarn add cookie-session`

- `yarn add @types/cookie-session --dev`

# POMENUTI PAAKET SE KORISTI KAO MIDDLEWARE

- `code auth/src/index.ts`

```ts
import express from "express";
import "express-async-errors";
import { json } from "body-parser";
import mongoose from "mongoose";
// UVOZIM POMENUTI PAKET
import cookieSession from "cookie-session";
//

import { currentUserRouter } from "./routes/current-user";
import { signInRouter } from "./routes/signin";
import { signOutRouter } from "./routes/signout";
import { signUpRouter } from "./routes/signup";
import { errorHandler } from "./middlewares/error-handler";
import { NotFoundError } from "./errors/not-found-error";

const app = express();

// ZATO STO SAM DOLE PODESIO DA JE COOKIE ONLY AVAILABLE AKO JE PODESEN SSL
// JA PRAVIM OVAJ SETTING
app.set("trust proxy", true);
// OVO GORE SAM PODESIO JER TRAFFIC PROXIED DO NASEG APP-A,
// KROZ INGRESS NGINX
// EXPRESS CE VIDETI THAT STUFF IS BEING PROXIED, I PO DEFAULT-U
// NECE TRUST-OVAATI HTTPS CONNECTION-U
// JA SAM DODAO GORNJI STEP, DA EXPRESS BUDE AWARE DA JE BEHIND
// A PROXY INGRESS NGINX-A
// I DA VERUJE TRAFFIC-U D JE ON SECURED IAKO DOLAZI SA TOG PROXY-JA
// OVO GORNJE OBJASNJENE MI JE TOLIKO NERAZUMLJIVO
//  MISLIM DA JE OVDE:
// https://stackoverflow.com/questions/23413401/what-does-trust-proxy-actually-do-in-express-js-and-do-i-need-to-use-it
// BOLJE OBJASNJENO

app.use(json());

// POVEZUJEM MIDDLEWARE NA OVOM MESTU
app.use(
  cookieSession({
    // DISABLE-UJEM ENCRYPTION KAKO SAM REKAO DA CU URADITI
    signed: false,
    // REQUIREMENT DA COOKIE WILL ONLY BE USED IF USER IS
    // VISITING APP, OVER A HTTPS CONNECTION (SMALL SECURITY EMPROVEMENT)
    secure: true,
  })
);
// POVEZAO SAM MIDDLEWARE NA GORNJEM MESTU
// KAKO BI DONJI ROUTER, ODNOSNO NJIHOVE ROUTE HANDLERI
// MOGLII DA KORISTE PARSED UP VALUE FROM THE COOKIE

app.use(currentUserRouter);
app.use(signInRouter);
app.use(signOutRouter);
app.use(signUpRouter);

app.all("*", async (req, res, next) => {
  throw new NotFoundError();
});

app.use(errorHandler);

const start = async () => {
  try {
    await mongoose.connect("mongodb://auth-mongo-srv:27017/auth", {
      useNewUrlParser: true,
      useUnifiedTopology: true,
      useCreateIndex: true,
    });

    console.log("Connected to DB");
  } catch (err) {
    console.log("Failed to connect to DB");
    console.log(err);
  }

  const PORT = 3000;
  app.listen(PORT, () => {
    console.log(`listening on  http://localhost:${PORT} INSIDE auth POD`);
  });
};

start();
```

**ONO STO SMO PODESILI JESTE DA MOZEMO PODESITI `Set-Cookie` HEADER NA RESPONSE-U, KOJI SALJEMO KORISNIKU**

## OSTAJE NAM SADA DA DEFINISEMO GENERATING JWT-A I NJEGOV SENDING U POMENUTOM RESPONSE-U

TIME CU SE BAVITI U SLEDECEM BRANCH-U
