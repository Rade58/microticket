# QUEUE GROUPS

DAKLE U PROSLOM BRANCHU SAM TI POKAZO KAKO TO SVAKI CLIENT, ODNOSNO SVAKI PUBLISHER I LISTENER MORAJ UBITI CONNECTED SA ISTIM CLIENT ID-JEM (SAMO TAKAV CONNECTING JE I MOGUC)

A TRENUTNO IMAM JEDNOG PUBLISHERA I DVA LISTENER-A

HAJDE DA MALO POPRAVIM LISTNER CODE, DA STMAPAM NESTO LEPSE, ON message

- `code nats_test_project/src/listener.ts`

```ts
import nats, { Message } from "node-nats-streaming";
import { randomBytes } from "crypto";

console.clear();

const stan = nats.connect("microticket", randomBytes(4).toString("hex"), {
  url: "http://localhost:4222",
});

stan.on("connect", () => {
  console.log("Listener connected to nats");

  const subscription = stan.subscribe("ticket:created");

  subscription.on("message", (msg: Message) => {
    // const eventNumber = msg.getSequence();
    // const topic = msg.getSubject();
    // console.log({ topic, eventNumber });
    const data = msg.getData();

    if (typeof data === "string") {
      const dataObject = JSON.parse(data);

      // console.log(dataObject.title);
      // console.log(dataObject.id);
      // console.log(dataObject.price);
    }
    // EVO ZELIM DA STMAPAM OVAKAV STRING
    console.log(`Received event #${msg.getSequence()}, with data: ${data}`);
    //
  });
});

```

SADA KADA RESTARTUJES PUBLISHERA (CIME SE PUBLISH-UJE EVENT), I KADA NATS STREAMING SERVER POSALJE EVENT-OVE, U TERMINALIMA LISTENERA CE SE STMAPTI OVO

ZA PRVI:

```zsh
Received event #16, with data: {"id":"123","title":"concert","price":20}

```

I ZA DRUGI:

```zsh
Received event #16, with data: {"id":"123","title":"concert","price":20}

```

## KAO STO VIDIS PO REDNOM BROJU (SEKVENCI), TI MOZES VIDETI DA JE OBEMA LISTENERIMA, KOJI SU SUBSCRIBED, USTVARI POSLAT SAME EVENT

DA LI TO MOZE BITI PROBLEMATICNO?

USTVARI DA LI JE TO PROBLEMATICNO, AKO MI SIMULIRAMO TO DA IMAMO DVE INSTANCE ISTOG MICROSERVICE-A, KOJI RECEIVE-UJU EVENT

DA LI JE PROBLEM STO OBE INSTANCE DOBIJAJU SAME EXACT EVENT

**MOZDA BI TO ZA NJIH PRESENT-OVALO AN ISSUE**

USTVARI ZAISTA BI TO BILO PROBLEM

AKO ZAMISLIS PROJEKAT, KOJI SAM RADIO NA POCETKU UPOZNAVANJA S MICROSERVICE-OVIMA

GDE SAM KORISTIO query MICROSERVICE, KOJI JE STORE-OVAO EVENTS, DODUSE IN MEMORY U JEDNOM ARRAY-U

**NAROCITO BI BIO PROBLEMATICAN EVENT, PRI KOJEM SE NESTO KEIRA, NA PRIMER `CommentCreated`, A RECIMO DA ZAMISLIS DA SI TADA KORISTIO DATBASE ZA STORING SVAKOG COMMENT-A**

**STA DA TI IMAS DVE INSTANCE ISTOG MICROSERVICE-A KOJE SU OBE SUBSCRIBED NA TKAV EVENT**

**PA DESILO BI SE DA OBE INSTANCE POCNU DA STORE-UJU ISTU STVAR U DATBASE; DAKLE MOGUCI SU DUPLIKATI U DATBASE-U**

# VEOMA CESTO TI NECES ZELETI DA DOZVOLIS DA ISTI EVENT FROM NATS STREMING SERVER ODE DO SVAKE KOPIJE NEKOG SERVICE-A, KOJ ISI TI HORIZONTALNO SCALE-OVAO DA IMA VISE INSTANCI TOG MICROSERVICE-A

**ZELIS DA SE POSTARAS DA EVENT UVEK DODJE DO JEDNE KOPIJE MICROSERVICE-A**

ALI KAKO MOZEMO TO POSTICI

POSTOJI NESTO BUILT IN NINTO NATS STREAMING SERVER STO CE OVO UCINITI DA BUDE VEOMA EASY

# KORISTICU NESTO STO SE ZOVE QUEUE GROUP

TO JE NESTO STO CE BITI KREIRANO INSIDE SPECIFIC CHANNEL INSIDE NATS STREAMING SERVER

JA ZA SADA UMOM PROJEKTU IMAM JEDAN CHANNEL: "ticket:created"

UPRAVO U TOM KANALU CU NAPRAVITI QUEUE GROUP

**MOZES IMATI MULTIPLE QUEUE GROUPS ASSOCIATED WITH ONE CHANNEL**

DACES NEKI SPECIFIC NAME QUEUE GRUPI, KOJI HOCES

DA ZAMISLIM DA SAM U, POMENUTOM KANALU KRIRAO NA PRIMER QUEUE GROUP, KOJI SE ZOVE `myQueueGroup`

**SADA BI U LISTENERIMA, ODNOSNO U SVAKOJ KOPIJI MICROSERVICE-A, NAPRAVIO SUBSCRIPTIONS NA TAJ QUEUE GROUP TOG KNALA**

NA TAJ NACIN MOR OR LESS RANDOMLY, NATS STREAMING SERVER BI SLAO EVENT SAMO JEDNOM SUBSCRIBERU, DA S TAKO IRZIM

**NA TAJ NACIN EVENT BI BIO PROSLEDJEN SAMO JEDNOJ OD KOPIJA MICROSERVICE-A**

## AKO IMAS NEKI, POTPUNO DRUGI MICROSERVICE, KOJI JE SUBSCRIBED NA ISTE CHANNEL; ON NE MORA DA KORISTI QUE GROUP, AKO TI TO NE ZELIS

ODNONO AKO JE TAKAV SERVICE DA MU NISU BITNE QUEUE GROUPS

ON MOZE GENERALLY DA LISTEN-UJE NA KANAL, NA PRIMER NA "ticket:created", BEZ DA KORISTI QUEUE GROUP

ODNOSNO NE MORA DA BUDE MEMBER TE QUEUE GRUPE

# QUEUE GROUP JE LAKO PODESITI

SAMO PRILIKOM DEFINISANJA SUBSCRIPTIONA, DODAS JOS JEDAN STRING, KOJIM DEFINISES IME QUEUE GRUPE

- `code nats_test_project/src/listener.ts`

```ts
import nats, { Message } from "node-nats-streaming";
import { randomBytes } from "crypto";

console.clear();

const stan = nats.connect("microticket", randomBytes(4).toString("hex"), {
  url: "http://localhost:4222",
});

stan.on("connect", () => {
  console.log("Listener connected to nats");

  // EVO VIDIS DODAO SAM GRUPU
  const subscription = stan.subscribe("ticket:created", "orders-microservice-queue-group");

  subscription.on("message", (msg: Message) => {
    const data = msg.getData();

    if (typeof data === "string") {
      const dataObject = JSON.parse(data);
    }

    console.log(`Received event #${msg.getSequence()}, with data: ${data}`);
  });
});
```

OVO SADA LAKO MOZES TESTIRATI

I DALJE IMAS DVA LISTENERA I JEDNOG PUBLISHERA

RESTARTUJ PUBLISHER SCRIPT, CIME CES POSLATI EVENT

**I ZAISTA SMO U TERMINALU, JEDNOG LISTENERA JE SADA STAMPANO ONO STO SAM PODESIO**

```zsh
Received event #17, with data: {"id":"123","title":"concert","price":20}
```

**STO ZNACI DA ONI, KOJI SU SUBSCRIBED NA ISTU QUEUE GRUPU, NE DOBIJAJ USVI EVENT, SAMO JEDAN OD SUBSCRIBERA DOBIJA EVENT OD NATS STREAMING SERVERA**

MOZES OPET DA POKUSAS SLANJE EVENT-OVA, I VIDECES KAKO NECE UVEK ISTI LISTENER DOBITI EVENT, DAKLE IT ALTERNATES BETWEEN THE TWO
