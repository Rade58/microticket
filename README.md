# RESTARTING THE DEPLOYMENT

U PROSLOB BRANCH-U, USPESNO SMO DEFINISALI BUILDING IMAGE-A I NJEGOV PUSHING TO DOCKER HUB; A SVE SMO TO DEFINISALI, KROZ WORKFLOW FILE, ODNOSNO GITHUB ACTION; ACTION KOJI SE IZVRSAVA ON `push` TO `main`; A ZA push TO `main`, SE ISTO RACUNA I **MERGING PULL REQUEST INTO** `main`

A SADA SE MORAMO POSTARATI DA KROZ ISTI FILE, DEFINISEMO I REACHING INTO RUNNING KUBENETES CLUSTER, KOJI IMAMO NA DIGITAL OCEAN-U; **I DA KAZEMO DEPLOYMENT-U, KOJI JE INSIDE THERE, I KOJI JE RESPONSIBILE FOR OUR POD FOR THE `auth` MICROSERVICE, DA KORISTI NOVI IMAGE**

DA BISMO TO URADILI PROCICEMO KROZ SLICAN PROCES KOJI SMO RANIJE DEFINISALI NA NASOJ LOKALNOJ MACHINE-I, KORISTECI `doctl` CLI

DAKLE POSMATRAMO WORKFLOW KOJI CE BITI RUNNED U GITHUB CONTAINER-U

**MI CEMO DEFINISATI DA SE U GITHUB CONTAINERU INSTALIRA `doctl`**

**NAKON INSTALIRANJA doctl MORAMO SE AUTHORIZE-OVATI, ODNONO MORAMO INICIALIZE-OVATI doctl, KORISCENJEM ONOG API KEY-A SA DIGITAL OCEAN-A (MOZEMO GENERISATI NOVI, ILI KORISTITI ONAJ KOJI SMO VEC NAPRAVILI)**

**ONDA CEMO KORISTITI `doctl` DA FETCH-UJEMO CONTEXT, KOJI DESCRIBE-UJE, KAKO SE KONEKTOVATI DO CLUSTER-A, KOJI RUNN-UJE INSIDE DIGITAL OCEAN**

**TAJ CONTEXT CEMO ONDA FEED-OVATI INTO `kubectl`, KOJI DOLAZI PREINSTALED INSIDE GITHUB CONTAINER**

DA SE BACIMO NA POSAO

OPET NA GITHUB-U OTVARAMO, ONAJ FILE: `/.github/workflows/deploy-auth.yml`

KAKO BISMO DODALI JOS STEP-OVA INSIDE

```yml
name: deploy-auth

on:
  push:
    branches:
      - main
    paths:
      - 'auth/**'
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2   
      - run: cd auth && docker build -t radebajic/mt-auth .
      - run: docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
      - run: docker push radebajic/mt-auth
      # REKAO SAM DA MORAMO doctl DA INSTALIRAMO MANUELNO
      # TO JE USTVARI OVO, NISMO BAS MANULNI, JER JE DIGITAL OCEAN
      # NAPRAVIO SHORTCUT, KAKO BI SE doctl INSTALIRAO AUTOMATSKI INSIDE
      # RUNNING GITHUB CONTAINER
      - uses: digitalocean/action-doctl@v2
        # OVO SLEDECE CE OMOGUCITI DA TOKEN KOJI SMO UNELI BUDE PROVIDED
        # TO THE SCRIPT, CIME CEMO DOBITI PREINITIALIZED VERSION OF doctl
        with:
          token: $DIGITALOCEAN_ACCESS_TOKEN
```

**IDEMO SADA U DIGITALOCEAN DASBOARD DA GENERISEMO NOVI TOKEN**

IDEMO U `ACOUNT` -> `API` -> (Personal access tokens) -> `Generate New Token`

TOKENU SAM DAO IME `github_access_token` KAKO BI BILO MORE DESCRIPTIVE

ZATIM SAM KOPIRAO TAJ TOKEN

**IDEMO SADA U GITHUB REPO, DA PODESIMO SECRET**

IDEMO U `Settings` TAB -> `Secrets` -> `New repository secret`

I DODAO SAM SECRET `DIGITALOCEAN_ACCESS_TOKEN`
