# BUILDING AN IMAGE IN A GITHUB ACTION

SADA CEMO SAGRADITI NAS PRVI WORKFLOW, KOJIM CEMO SE POSTARATI DA SE BUILD-UJE IMAGE FOR THE `auth` MICROSERVICE; DA SE ON ONDA PUSH-UJE TO DOCKER HUB; I OSTALO

DAKLE OPET IDEMO NA NAS REPO NA GITUB-U I BIRAMO `Actions` TAB; I KLIKCEMO NA `New Workflow` PA KLIKNI DA `set up a workflow yourself`

IZBRISI SAV CODE KOJI JE VEC TAMO BIO DEFINISAN I ZADAJ IME ZA WORKFLOW DA BUDE `deploy-auth.yml`

SADA CEMO PISATI CONFIIG KOJI CE DICTATE-OVATI KADA CE SE RUNN-OVATI, I STA CE EXACTLY RADITI

EVO TI ZA POCETAK DEFINISEMO DA SE ACTION RUNN-UJE SAMO AAKO SE DESILA PROMENA U `auth` FOLDERU

**ALI VIDECES DA SAM DEFINISAO DA SE ACTION OBVLJA ZA `push` RELATED TO `main` BRANCH**

`deploy-auth.yml`:

```yml
name: deploy-auth

on:
  push:
    branches:
      - main
    paths:
      - 'auth/**'
```

**ZASTO `push`?**

**PA KADA GOD MI CLOSE-UJEMO ILI MERGE-UJMO PULL REQUEST; THAT COUNTS AS A `push` DIRECTLY TO THE `main` BRANCH** (**`D TO POTPUNO IMA SMISLA`**)

DAKLE CHECK KOJ ISAM PODESIO RUNN-OVCE POMENUTI WORKFLOW ,SVAKI PUT KADA MERGE-UJEMO PULL REQUEST INTO THE MASTER BRANCH

A RUNN-OVACE SE SAMO AKO POSTOJI CHANE U `auth` FOLDERU

SADA CEMO DA DODAMO JOBS

`deploy-auth.yml`:

```yml
name: deploy-auth

on:
  push:
    branches:
      - main
    paths:
      - 'auth/**'
# EVO, OVO DODAJEM
# ZADAJEM MU IME build
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
# OVO ZNACI CHECKOUT ALL OF OUR CODE INSIDE OF OUR REPO
      - uses: actions/checkout@v2
# SADA DEFINISEMO KOMANDE KOJE CE SE RUNN-OVATI
# SAMO DA TI KAZEM DA ubuntu-latest DOLAZI SA PREINSTALLED 
# DOCKEROM, TAKO DA TU INSTALACIJU INSIDE COMMAND, NE MORAS
# DEFINISATI 
      # mt MI JE SKARACENO ZA microticket (TO MI JE NAJLOGICNIJE DA SMISLIM)      
      - run: cd auth && docker build -t radebajic/mt-auth 

# NAKON STO SE BUILD-UJE IMAGE, TREBA DA SE PUSH-UJE TO DOCKER 
# HUB
# ALI MORAS BITI LOGGED IN INTO DOCKER CLI; DAKLE DOCKER CLI MORA ZNATI
# KO SI TI ZAPRAVO, DA BI SME DA PUSH-UJES TO DOCKER HUB
# ALI PROBLEM JE ST OSE SCRIPT NECE EXECUTE-OVATI NA MOJOJ LIKALNOJ
# MACHINE, VEC U CONTAINERU KOJI MANGE-UJE GITHUB GITHUB-A
# MORAMO NEKAKO RECI DOCKERU DA ME LOGG-UJE KORISTECI
# MOJE IME I PASSWORD
# NECEMO IME I SIFRU UNOSITI DIREKTNO U SCRIPT OVDE
# VEC CEMO DODATI USER NAME I PASSWORD, KO SECRET
```

# DAKLE MOJE DOCKER CREDENTIALS DODAJEM INTO REPOSITORY KAO SECRET

COMMIT-UJ GORNJI FILE ZA SADA (PRITISNI `Start Commit` DUGME I OSTALO), KAKO BI MOGLI DA SE NAVIGTE-UJEMO AWAY, JER CEMO MORATI DA PRITISNEMO NA `Settings` TAB NASEG REPO-A (MADA SMO MOGLI DA `Settings` OTVORIMO U NOVOM BROWSER-OVOM TABU)

UGLAVNOM OTVORILI SMO `Settings` --> `Secrets` --> `New repository secret`

DODAO SAM `DOCKER_USERNAME` SECRET

PA SAM DODAO JOS JEDAN SECRET, A TO JE `DOCKER_PASSWORD`

SADA IMAMO DOSTUPNIM POMENUTE SECRET-OVE U NASIM GITHUB ACTIONIMA, KAO ENV VARIABLES

# VRACAMO SE DA EDIT-UJEMO NAS WORKFLOW FILE, KAKO BI SMO REFERENCIRALI SECRETS, KOJE SAM PODESIO ;A TO SE RADI UZ DODAVANJE $ SIGN-A ISPRED ENV VARIABLE-A; ALI MORACES DA PODESIS ENV VARIABLES

I PAZI DA NE NAPRAVIS NEKI TYPO

```yml
name: deploy-auth

on:
  push:
    branches:
      - main
    paths:
      - 'auth/**'
jobs:
  # JA SAM job-U DAO IME build JER JE LOGICNO
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2   
      - run: cd auth && docker build -t radebajic/mt-auth .
      # UNOSIM NOVI run
      # KAO STO VIDIS REFERENCIRAM SECRETS KAO ENV VARIABLES
      - run: docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
        env:
          # A OVDE USTVARI PODESAVAMKOJE DA SE SE SECRETS UZMU I PODESE
          # KAO ENV VARIABLES
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
      # SADA MOZEMO DEFINISATI PUSHING IMAGE-A TO DOCKER HUB
      - run: docker push radebajic/mt-auth
```

MOZEMO DA COMMIT-IJEMO OVAJ FILE (`Start commit` DUGME)

# MOZEMO SADA DA POKUSAMO OVO DA TESTIRAMO, TAKO STO CEMO PRECI U NAS `dev` BRANCH, PA CEMO NAPRAVITI NEKE IZMENE U `auth` MICROSERVICE-U, PA CEMO TO COMMIT-OVATI I PUSH-OVACEMO TO REMOTE `dev` BRANCH; A ONDA CEMO NA GITHUB-U NAPRAVITI PULL REQUEST TO MERGE `dev` INTO `main`

- `git checkout dev`

EVO SADA PRAVIM PROMENU U `auth` MICROSERVICE CODEBASE-U

PA COMMIT-UJEM

- `git add -A && git commit -am "auth changes"`

PA PUSH-UJEM

- `git push origin dev`

**SADA IDEM NA GITHUB I OTVARAM, ODNONO KREIRAM NOVI PULL REQUEST FOR MERGING `dev` INTO `main`**

ONI TESTOVI SE SADA RUNN-UJU ZA auth MICROSERVICE, KAO REZULTAT ONOG WORLKFLOWA KOJEG SAM PODESIO RANIJE, I TO JE PROSLO USPESNO

**`ALI NAS WORKFLOW KOJI SMO PODESILI, A TICE SE BUILDING-A DOCKER IMAGE, CE SE POKRENUTI TEK KADA SE push-UJE TO MAIN; ODNONO KAD SE PULL REQUEST MERGE-UJE INTO MAIN`**

**DAKLE PRITISKAM NA `Merge pull request` I OBAVLJAM MERGING**

***

**MEDJUTI MDA BI PRATIO KAKO SE ACTION OBAVLJA, A O NCE SE SIGURNO OBAVLJATI, IDI U `Actions` TAB**

KLIKNI NA ACTION, BICE PRVI I IMACE ZUTU BOJU, VIDECES KAKOO SE ZUTU KRUZIC OKRECE OKO RECI `build` (**TAKVO IME SMO DALI NASEM JOB-U, SECAS SE (TO JE build)**)

KLIKNI NA `build` ON LEFT HAND SIDE

MOZES POSMATRATI SVE KORAKE KAKO SE DESAVAJU, DAKLE LOGS

VIDIM DA JE SVE USPESNO ODRADJENO

SADA VREC VIDIM I ZELENI CHECMARK ZA SVE

DAKLE IMAGE JE USPENO BUILD I PUSHED TO DOCKER HUB

**CISTO DA SE UVERIS, OTVORI DOCKER HUB, I VIDI DA LI TI JE TAMO IMAGE**

ZAISTA JESTE

## SADA BI TREBALO DA OPET DODAMO NESTO INSIDE ACTION; KAKO BI SMO OMOGUCILI DA SE NAKON BUILDINGA DOCKER IMAGE, I NJEGOVOG PUSHINGA NA DOCKER HUB, UPRAVO UZEM TAJ IMAGE I APPLY-UJE NA CLUSTER-U NA DIGITAL OCEAN-U

ALI ISTO TAKO MORAMO DA PODESIMO I INGRESS, KAO BI OMOGUCILI DA REQUEST KOJI SE PRAVE PREMA auth MICROSERVICE-U BUDU ROUTED DO auth MICROSERVICE-A U CLUSTER-U

