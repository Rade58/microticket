# CREATING A QUEUE

***
***

digresija1:

**NEMOJ SLUCAJNO DA MESAS OVO ZA QUEUE GROUP-AMA NEKOG KNALA, U NATS STREAING SERVERU**

TO SSU POTPUNO RAZLICITE STVARI (SAMO TI NAPOMINJEM)

***
***

***
***

digresija2:

ZABORAVIO SAM RANIJE DA INSTALIRAM TYPE DEFFINITIONS ZA BULL, TAKO DA CU TO SADA URADITI

- `cd expiration`

- `yarn add @types/bull`

***
***


- `mkdir expiration/src/queues`

U SLEDECEM FILE-U STAVICU MNOGO ACODE-A, RELATED TO Bull JS

- `touch expiration/src/queues/expiration-queue.ts`

HAJDE DA NAPRAVIM OVERVIEW STA CU JA USTVARITI RADITI

1. "`order:created`" EVENT STIZE U `exoiration` MICROSERVICE

2. KORISTICEMO JEDNU STVAR KOJA CE SE ZVATI `expirationQueue`, I KOJ UCEMO DEFINISATI U FILE-U KOJ ISMO MALOCAS KREIRALI

KORISTICEMO JE KAKO BI SMO ENQUEUE-OVALI NOVI JOB

O `JOB`-U MOZEMO RAZMISLJATI KAO O NECEMU STO JE SIMILAR IN NATURE, TO THE EVENT

DAKLE PISACEMO **CODE TO ENQUEUE A JOB**, ILI ESENTIALLY MOZEMO RECI DA TADA "PUBLISH-UJEMO JOB"

3. POMENUTI JOB BICE SENT TO REDIS SERVER

TAMO CE BITI LIST OF DIFFERENT JOBS, KOJI CE IMATI TYPE **`"order:expiration"`**

DAKLE JOB KOJI JE SENT DO REDIS SERVERA CE NA SEBI IMATI TYPE, KOJI CE BITI STRING DESCRIPTION (EKVIVALENTNO ONOM SUBJECTU, ILI CHANNEL-U KADA GOVORIMO O NATS-U)

4. JOB CE ONDA TEMPORRY BITI STORED U REDIS-U

I BICE STORED TAMO, DOK NE ELAPS-UJE 15 MINUTA ILI SLICNO

5. KADA VREME PROTEKNE REDIS SERVER CE UZETI JOB I POSLACE GA NAAD DO `expirationQueue`-A

A TO CEMO IMATI CODE DEDICATED ZA PROCESSING INCOMMING JOB-A

6. KADA SE PROCESS-UJE JOB, ZELIM ODA EMMIT-UJEMO EVENT **`expiration:complete`**

## MI CEMO MORATI DA FIGURE0-UJEMO OUT, KAKVU CEMO TO INFORMACIJU MI ZELETI DA STORE-UJEMO INSIDE A JOB OBJECT

MORAMO DA STORE-UJMO NESTO STO UKAZUJE O TOM O KOJEM SE TO ORDERU RADI, KOJEG ZELIMO DA EXPIRE-UJEMO

NAJBOLJE DA TO BUDE `orderId`

NISTA DRUGO I NETREBA

orderId JEDINO TREBA DA BUDE ONO STO CE SE PUBLISHOVATI SA `"expiration:complete"` EVENTOM

# SADA MOZEMO DA POCNEMO DA PISEMO CODE ZA SVE STO SMO GORE POMENULI

- `code expiration/src/queues/expiration-queue.ts`

```ts
import Queue from "bull";

// KORISTICU GORNJU STVAR, DA NAPRAVIM NOVU Queue INSTANCU
// I NAZVACEMO JE       expirationQueue

// DAKLE TO CE BITI STVAR KOJA CE NAM OMOGUCITI DA PUBLISH-UJEMO JOB
// (ODNOSNO DA GA ENQUEUE-JEMO)

// A TO CE SLUZITI I DA EVENTUALLY PROCESS-UJE JOB KOJI DOLAZI
// IZ REDIS INSTANCE

// PRVI ARGUMENT JE TYPE OF QUEUE, A MOZES O TOME RAZMISLJATI KAO O CHANNEL NAME-U
// MOZEMO O QUEUE TYPE-U RAZMISLATI KAO O NECEMU STO NAS VEZE ZA BUCKET
// U REDIS SERVERU, U KOJEM ZELIMO DA, PRIVREMENO STORE-UJEMO JOB
// FORMAT STRINGA, ZA QUEUE TYPE NIJE BITAN, ALI JA VOLIM
// DA STAVLJAM ISTI FORMAT, KAKV JE ONAJ KOJI KORISTIMO
// ZA ZADAVANJE CHANNEL NAME-A, ODNOSNO SUBJECT-A

// DRUGI ARGUMENT JE OPTIONS OBJECT

const expirationQueue = new Queue("order:expiration", {
  // SA OVIM OPCIJAMA GOVORIMO QUEUE-U
  // DA ZELIMO DA SE KONEKTUJEMO DO INSTANCE REDIS SERVER-A
  // KOJU RUNN-UJEMO U POD-U, KOJU SMO NE TAKO DAVNO KREIRALI
  // APLY-UJUCI ONAJ DEPLOYMENT FILE
  redis: {
    // MOZEMO NACI HOST U CONFIG FILE-U ZA DEPLOYMENT I CLUSTER IP
    // NASEG expiration MICROSERVICE-A, JER TAMO
    // SMO DEFINISALI ENV VARIABLE ZA host
    host: process.env.REDIS_HOST,
  },
});

```

# ZBOG TOGA DA UVEK ZNAMO STA SE STAVLJA U JOB OBJECT, I STA MOZEMO PROCITATI SA JOB OBJECT-A, NAPRAVICEMO JEDAN TYPESCRIPT INTERFACE

INTERFACE CE SE ZVATI `PayloadI`

- `code expiration/src/queues/expiration-queue.ts`

```ts
import Queue from "bull";

// EVO GA INTERFACE
interface PayloadI {
  orderId: string;
}

// A OVDE GA PASS-UJEMO KAO GENERIC TYPE
const expirationQueue = new Queue<PayloadI>("order:expiration", {
  redis: {
    host: process.env.REDIS_HOST,
  },
});
```

# SADA CEMO NAPISATI CODE DEDICATED TO PROCESSING A JOB

DAKLE PIECE OF CODE KOJI PROCESS-UJE JOB SENT BY REDIS SERVER

- `code expiration/src/queues/expiration-queue.ts`

```ts
import Queue from "bull";

interface PayloadI {
  orderId: string;
}

// ZABORAVIO SAM DA EXPORT-UJEM QUEUE
export const expirationQueue = new Queue<PayloadI>("order:expiration", {
  redis: {
    host: process.env.REDIS_HOST,
  },
});

// EVO OVO JE, POMENUTI PIECE OF CODE

expirationQueue.process(async (job) => {
  // NA job-U ,LAKO MOZES VIDETI STA MOZE DA BUDE
  job.data.orderId;

  // job OBJECT JE SIMILR IN NATURE, KAO ONAJ msg: Message
  // KADA LISTEN-UJEMO FOR THE EVENT, KORISTECEI node-nats-streaming

  // PORED data NA job-U IMA MNOGO STAVI, OD DATE, KADA JE INITIALLY
  // CREATED, ILI NEKI ID OF JOB ITSELF ILI WHAT EVER ELSE

  // EVENTUALLY MI CEMO OVDE PUBLISH-OVATI `"expiration:complete"` EVENT
  // AL IZA SADA CEMO SAM ONA NESTO LOG-UJEMO

  console.log(
    "I want to publish event to 'expiration:complete' channel. Event data --> orderId",
    job.data.orderId
  );
});

```
