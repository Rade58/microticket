# CLIENT HEALTH CHECKS

DA TI PRVO PREDSTAVIM JEDAN PROBLEM 

DA TE PODSETIM

DAKLE IMAM DVA NASA SUBSCRIPTION, KOJA SU ACTIVE I ZA KOJE SAM DEFINISAO QUEUE GROUP, I ZA KOJE MORAM MANUELNO DA POTVRDIM AKNOWLEDMENT U message LISTENERU (VRATI SE U PREDHODNE BARANCHEVE AKO TI NIJE JASNO)

IMAM TAKODJE PUBLISHERA KOJI JE ACTIVE I KOJI SALJE MESSAGE ODMAH NAKON STO SE RUNN-UJE `publisher.ts` (PROSTO RECENO HARCODE-OVAO SAM T JSENDING DA MORA EXECUTABLE DA SE RESTARTUJE DA BI SE PUBLISH-OVAO EVENT) (VRATI SE U PREDHODNE BARANCHEVE AKO TI NIJE JASNO)

**UGASICU NAKRATTKO OBA LISTENERA**

SADA NEMA NIKOG DA LISTEN-UJE


ALI HAJDE DA BRZOM BRZINOM VRATIMO SADA ODMAH LISTENERE, DA IH OPET POKRENEMO

I ODMAH POSLE TOGA BRZOM BRZINOM

**RESTARTOVACU PUBLISHER SCRIPT DA BI OPET DOSLO DO PUBLISHINGA EVENTA**

PROBLEM JE U TOME STO NEKADA

**`TAJ EVENT NECE BITI PROSLEDJEN DO LISTENERA`**

SADA MOZES OPET DA RESTARTUJES PUBLISHERA ODNOSNO DA PUBLISH-UJES EVENT

DATA CE SE ODMAH STMAPTI U JEEDNOM OD LISTENER TERMINALA STO ZNACI DA JE ON TAJ EVENT USPESNO POSLAT

**ALI NAKON NEKOLIK ODESETINA SEKUNDI, JEDAN TERMINAL JEDNOG LISTENERA CE STAMPATI KAO REZULTAT ONOGG EVENT KOJI JE POSLAT KADA U SVI LISTENERI BILI DOWN**

STO ZNACI DA SE EVENT SA VECIM REDNIM BROJEM REGISTROVAO PRE ONOGA SA MANJIM REDNIM BROJEM

# DA BI VIDEO ZASTO SE OVO DESAVA TI MORS MALO DA DIGG-UJES INSIDE NATS STREAMING SERVER

KADA SA NATS STREAMING SERVER INSTATICIZIRAO U POD U TVOM CLUSTERU, TI SI ZA NJEGA ZADAO DVA PORTA

EVO POGLEDAJ

- `cat infra/k8s/nats-depl.yaml`

```yaml
# ...
# OVO TI JE DDEO KONFIGURACIJE ZA CLUSTER IP
spec:
  selector:
    app: nats
  ports:
    # DODAO SI JEDAN PORT
    # TO JE PORT KOJ ISI EXPOSE-OVAO DA BI MOGAO
    # DA SE KONEKTUJES SA CLIENTIMA KOJI SU NA MOM LOKALNOM RACUNARU
    - name: client
      protocol: TCP
      port: 4222
      targetPort: 4222
      # ALI TU JE I DRUGI PORT, A KO STO VIDIS DAO SI MU IIME
      # MONITORING
    - name: monitoring
      protocol: TCP
      port: 8222

```

# MOZEMO DA ACCESS-UJEMO NATS STREAMING SERVIR NA MONITORING PORT-U I DOBICEMO ODATLE A LOT OF DIFFRENT INFORMATIONS FROM ALL SUBSCRIPTIONS WE CREATED, FROM ALL DIFFERENT CLIENT; MOZMO ACCESS-OVATI STATISTICS AND STUFF LIKE THAT

OTVORI NOVI TERMINAL

- `kubectl get pods`

```zsh
NAME                                  READY   STATUS    RESTARTS   AGE
auth-depl-865bdcff84-zq5c8            1/1     Running   0          24h
auth-mongo-depl-fff5dcdd9-lhwz7       1/1     Running   0          24h
client-depl-68d8f8cbd5-wpcl5          1/1     Running   0          24h
nats-depl-f878fb4f9-k6fgq             1/1     Running   0          24h
tickets-depl-6b9c6b485c-lsvgq         1/1     Running   0          24h
tickets-mongo-depl-8456f7b84c-8bbzl   1/1     Running   0          24h
```

- `kubectl port-forward nats-depl-f878fb4f9-k6fgq 8222:8222`

**TI SADA MOZES OTVORITI BROWSER I UKUCATI**

`http://localhost:8222/streaming`

![localhst](images/localhost8222.jpg)

DAKLE U PITANJU JE NATS STREAMING SERVER MONITORING PAGE

KLIKCI I GLEDAJ RZLICITI STATS ABOUT OUR STREAMING SERVER

POSTO POSMATRAS JSON DATA SKINI NEKI CHROME EXTENSSION DA TI LEPO FORMATIRA TO, MEDJUTIM JA SAM NA BRAVE BROWSERU I ON TO LEPO FORMATIRA

NAJVAZNIJE STO MOZES VIDETI SU

clients:

```json
{
  "cluster_id": "microticket",
  "server_id": "gJdbZHGPGN7jortjoENBVc",
  "now": "2021-04-23T13:21:13.916042283Z",
  "offset": 0,
  "limit": 1024,
  "count": 3,
  "total": 3,
  "clients": [
    {
      "id": "5ea96532",
      "hb_inbox": "_INBOX.LAF6FLRAX9NIWYZANC2FQA"
    },
    {
      "id": "abc",
      "hb_inbox": "_INBOX.CWUTWK0FJWKXKLSXAQB9G6"
    },
    {
      "id": "c343ebfa",
      "hb_inbox": "_INBOX.HWBBS0JJKCMQ2ECODTFKZ7"
    }
  ]
}
```

LISTET TI JE SVAKI CONNECTED CLIENT TO NATS STREAMING SERVER

SECAS SE DA SI PODESIO `"abc"` CLIENT ID ZA PUBLISHERA, DOK SI ZA LISTENERA TO RANDOMIZO-OVAO; IMAS DVA LISTENERA
